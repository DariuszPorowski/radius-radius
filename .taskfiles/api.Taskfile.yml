# yaml-language-server: $schema=https://taskfile.dev/schema.json
# docs: https://taskfile.dev
---
version: "3"

tasks:
  # * Install Autorest
  install:autorest:
    desc: Install Autorest
    cmds:
      - task: :internal:_install:npm
        vars:
          APP: autorest@{{.VERSION.autorest}}

  # * Install OAV
  install:oav:
    desc: Install OAV
    cmds:
      - task: :internal:_install:npm
        vars:
          APP: oav@{{.VERSION.oav}}

  # * Install TypeSpec
  install:typespec:
    desc: Install TypeSpec
    cmds:
      - task: :internal:_install:npm
        vars:
          APP: "@typespec/compiler@{{.VERSION.typespec}}"

  # * Tools
  tools:
    desc: Install API tools
    vars:
      ITEMS:
        - autorest
        - oav
        - typespec
    cmds:
      - for: { var: ITEMS }
        task: install:{{.ITEM}}

  # * Run TypeSpec Format
  run:tsp:format:
    desc: Run TypeSpec Format
    preconditions:
      - sh: task internal:command -- tsp
        msg: "❌ Error: tsp is not installed. Please run 'task api:install:typespec'"
      - sh: task internal:command:version -- "tsp --version" "{{.VERSION.typespec}}"
        msg: "❌ Version Mismatch: You are not using {{.VERSION.typespec}} version. Please run 'task api:install:typespec'"
    sources:
      - "**/*.tsp"
    cmds:
      - tsp format "**/*.tsp"
    dir: "{{.ROOT_DIR}}"

  # * Lint
  lint:
    desc: Lint API files
    cmds:
      - task: run:tsp:format
