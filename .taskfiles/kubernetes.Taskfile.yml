# yaml-language-server: $schema=https://taskfile.dev/schema.json
# docs: https://taskfile.dev
---
version: "3"

tasks:
  # * Install Kubectl
  install:kubectl:
    desc: Install Kubectl
    cmds:
      - task: :internal:_install:winget
        vars:
          APP: Kubernetes.kubectl
          VERSION: "{{.VERSION.kubectl}}"
      - task: :internal:_install:brew
        vars:
          APP: kubernetes-cli@{{.VERSION.kubectl}}
      - cmd: |
          # TODO
          {{.APT_UPDATE}} && {{.APT_INSTALL}} apt-transport-https ca-certificates curl gnupg
            curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.34/deb/Release.key | sudo gpg --dearmor --batch --yes -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
          sudo chmod 644 /etc/apt/keyrings/kubernetes-apt-keyring.gpg
          {{.APT_UPDATE}} && {{.APT_INSTALL}} kubectl
        platforms: [linux]
        # - cmd: |
        #       # TODO
        #       curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
        #       chmod +x kubectl
        #       mkdir -p ~/.local/bin
        #       mv ./kubectl ~/.local/bin/kubectl

  # * Install Helm
  install:helm:
    desc: Install Helm
    cmds:
      - task: :internal:_install:winget
        vars:
          APP: Helm.Helm
          VERSION: "{{.VERSION.helm}}"
      - task: :internal:_install:brew
        vars:
          APP: kubernetes-helm@{{.VERSION.helm}}
      - cmd: |
          # TODO
          {{.APT_UPDATE}} && {{.APT_INSTALL}} curl gpg apt-transport-https
          curl -fsSL https://packages.buildkite.com/helm-linux/helm-debian/gpgkey | gpg --dearmor | sudo tee /usr/share/keyrings/helm.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/helm.gpg] https://packages.buildkite.com/helm-linux/helm-debian/any/ any main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
          {{.APT_UPDATE}} && {{.APT_INSTALL}} helm
        platforms: [linux]

  # * Install Kind
  install:kind:
    desc: Install Kind
    cmds:
      - task: :internal:_install:winget
        vars:
          APP: Kubernetes.kind
          VERSION: "{{.VERSION.kind}}"
      - task: :internal:_install:brew
        vars:
          APP: kind@{{.VERSION.kind}}
      - cmd: |
          # TODO
          # For AMD64 / x86_64
          [ $(uname -m) = x86_64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/{{.VERSION.kind}}/kind-linux-amd64
          # For ARM64
          [ $(uname -m) = aarch64 ] && curl -Lo ./kind https://kind.sigs.k8s.io/dl/{{.VERSION.kind}}/kind-linux-arm64
          chmod +x kind
          mkdir -p ~/.local/bin
          mv ./kind ~/.local/bin/kind
        platforms: [linux]

  # * Install K3d
  install:k3d:
    desc: Install K3d
    cmds:
      - task: :internal:_install:winget
        vars:
          APP: k3d.k3d
          VERSION: "{{.VERSION.k3d}}"
      - task: :internal:_install:brew
        vars:
          APP: k3d@{{.VERSION.k3d}}
      - cmd: |
          # TODO
          curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | {{if ne .VERSION.k3d "latest"}}TAG="{{.VERSION.k3d}}" {{end}}bash
        platforms: [linux]

  # * Install EnvTest Manager
  install:envtest:
    desc: Install EnvTest Manager
    cmds:
      - task: :internal:_install:go
        vars:
          APP: sigs.k8s.io/controller-runtime/tools/setup-envtest@{{.VERSION.envtest}}

  # * Install Stern
  install:stern:
    desc: Install Stern
    cmds:
      - task: :internal:_install:winget
        vars:
          APP: stern.stern
          VERSION: "{{.VERSION.stern}}"
      - task: :internal:_install:brew
        vars:
          APP: stern@{{.VERSION.stern}}
      - cmd: |
          # TODO
          asdf plugin add stern
          asdf install stern "{{.VERSION.stern}}"
        platforms: [linux]

  # * Tools
  tools:
    desc: Install Kubernetes tools
    vars:
      ITEMS:
        - kubectl
        - helm
        - kind
        - k3d
    cmds:
      - for: { var: ITEMS }
        task: install:{{.ITEM}}
      - task: install:envtest
